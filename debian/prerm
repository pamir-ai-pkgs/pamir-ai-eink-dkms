#!/bin/sh

set -e

PACKAGE_NAME="pamir-ai-eink"
PACKAGE_VERSION="1.0.0"

case "$1" in
remove | upgrade | deconfigure)
	echo "Removing pamir-ai-eink-dkms..."

	# Unload modules if they are loaded
	echo "Unloading kernel module..."
	if lsmod | grep -q "^pamir-ai-eink"; then
		echo "Unloading pamir-ai-eink..."
		rmmod "pamir-ai-eink" || echo "Warning: Failed to unload pamir-ai-eink"
	fi

	# Remove device tree overlay configuration from config.txt
	CONFIG_FILE="/boot/firmware/config.txt"
	OVERLAY_LINE="dtoverlay=pamir-ai-eink"
	COMMENT_LINE="# Pamir AI E-Ink FB - Added by pamir-ai-eink-dkms package"

	if [ -f "${CONFIG_FILE}" ]; then
		echo "Removing device tree overlay configuration from ${CONFIG_FILE}..."

		# Create backup with proper error handling
		if ! cp -a "${CONFIG_FILE}" "${CONFIG_FILE}.backup"; then
			echo "Error: Failed to create backup of ${CONFIG_FILE}" >&2
			exit 1
		fi

		# Remove overlay configuration using sed with atomic operation
		if sed -i "/^${OVERLAY_LINE}/d; /^${COMMENT_LINE}/d" "${CONFIG_FILE}"; then
			rm -f "${CONFIG_FILE}.backup"
			echo "Device tree overlay configuration removed from ${CONFIG_FILE}"
		else
			# Restore from backup on failure
			mv "${CONFIG_FILE}.backup" "${CONFIG_FILE}"
			echo "Error: Failed to modify ${CONFIG_FILE}, restored from backup" >&2
			exit 1
		fi
	else
		echo "Warning: ${CONFIG_FILE} not found, skipping config removal"
	fi

	# Remove from DKMS
	if dkms status -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" | grep -q "${PACKAGE_NAME}"; then
		echo "Removing ${PACKAGE_NAME} from DKMS..."
		dkms remove -m "${PACKAGE_NAME}" -v "${PACKAGE_VERSION}" --all || true
	fi
	;;

failed-upgrade) ;;

*)
	echo "prerm called with unknown argument \`$1'" >&2
	exit 1
	;;
esac

#DEBHELPER#

exit 0
